<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡€å£“ç´€éŒ„å°å¹«æ‰‹</title>

    <!-- PWA åŸºæœ¬è¨­å®š -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d9488">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="è¡€å£“ç´€éŒ„å°å¹«æ‰‹">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">

    <!-- ä½¿ç”¨ Tailwind CSS å¿«é€Ÿæ§‹å»ºä»‹é¢ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- åœ–è¡¨åº« Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- åœ–ç¤ºåº« Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary-teal: #0d9488;       /* æ¹–æ°´ç¶  - èˆ’å¼µå£“ */
            --primary-red: #e11d48;        /* ç´…è‰² - æ”¶ç¸®å£“ */
            --primary-amber: #d97706;      /* æ©˜é»ƒè‰² - å¿ƒè·³ */
            --warning-bg: #FFD2D2;         /* ç•°å¸¸æé†’èƒŒæ™¯è‰² */
        }
        body {
            font-size: 16px;
            background-color: #f8fafc;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        input[type=range] {
            height: 10px;
            border-radius: 5px;
        }
        .btn-tap {
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .btn-tap:active { transform: scale(0.9); }

        /* è‡ªå®šç¾© Toast æç¤º */
        #toast {
            visibility: hidden;
            min-width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 12px;
            padding: 12px;
            position: fixed;
            z-index: 1050;
            left: 50%;
            bottom: 90px;
            transform: translateX(-50%);
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein { from {bottom: 70px; opacity: 0;} to {bottom: 90px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 90px; opacity: 1;} to {bottom: 70px; opacity: 0;} }

        .nav-btn {
            @apply flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors;
        }
        .nav-btn.active {
            @apply text-teal-600 font-bold;
        }
        .nav-btn span {
            @apply text-xs mt-1;
        }

        .pill {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 700;
        }

        .entry-selected {
            outline: 2px solid rgba(13, 148, 136, 0.35);
            background-color: rgba(13, 148, 136, 0.04);
        }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-24 bg-gray-50">

    <header class="bg-teal-600 text-white p-3 shadow-md sticky top-0 z-50">
        <h1 class="text-xl font-bold text-center">ğŸ’– è¡€å£“ç´€éŒ„å°å¹«æ‰‹</h1>
    </header>

    <main class="p-3">

        <!-- ================= é é¢ 1: ä»Šæ—¥è¨˜éŒ„ ================= -->
        <div id="page-record" class="page-content space-y-4">

            <!-- æ—¥æœŸ + æ™‚é–“ -->
            <section class="bg-white p-2 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <button onclick="changeDate(-1)" class="btn-tap bg-gray-100 rounded-full text-gray-600">
                        <i data-lucide="chevron-left" size="24"></i>
                    </button>
                    <input type="date" id="recordDate" class="text-xl font-bold border-none bg-transparent focus:ring-0 text-center text-teal-800" onchange="loadDataByDate()">
                    <button onclick="changeDate(1)" class="btn-tap bg-gray-100 rounded-full text-gray-600">
                        <i data-lucide="chevron-right" size="24"></i>
                    </button>
                </div>

                <p id="dateStatus" class="text-center text-xs text-teal-600 mt-1 font-medium">ä»Šå¤©</p>

                <div class="mt-2">
                    <div class="grid grid-cols-3 gap-2 items-end">
                        <div class="col-span-2">
                            <label class="block text-[10px] text-gray-500 mb-1">ç´€éŒ„æ™‚é–“ï¼ˆ24 å°æ™‚åˆ¶ï¼‰</label>
                            <input type="time" id="recordTime" class="w-full border border-gray-200 rounded-xl p-2 text-lg font-black text-center text-teal-800" onchange="onTimeChanged()">
                        </div>
                        <div class="col-span-1 flex items-end justify-center">
                            <button onclick="setNowTime()" class="w-[60%] py-2 bg-teal-600 text-white rounded-xl font-bold shadow text-sm active:bg-teal-700">ç›®å‰</button>
                        </div>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-1">é–‹å•Ÿ APP æ™‚æœƒå¸¶å…¥ç•¶ä¸‹æ™‚é–“ï¼›éœ€è¦é‡æ–°æŠ“ç›®å‰æ™‚é–“è«‹æŒ‰ã€Œç›®å‰ã€ã€‚è‹¥è¦è£œç™»å¯è‡ªè¡Œèª¿æ•´ã€‚</div>
                </div>
            </section>

            <!-- æœ¬æ—¥å¤šæ¬¡ç´€éŒ„åˆ—è¡¨ -->
            <section class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-bold text-gray-700">
                        æœ¬æ—¥ç´€éŒ„
                        <span id="daySummary" class="ml-2 text-[11px] font-bold text-teal-700"></span>
                    </h3>
                    <span id="editingBadge" class="text-[11px] px-2 py-1 rounded-full bg-teal-50 text-teal-700 font-bold border border-teal-100 hidden">ç·¨è¼¯ä¸­</span>
                </div>
                <div id="dayEntries" class="mt-3 space-y-2"></div>
                <p class="text-[10px] text-gray-400 mt-2">æç¤ºï¼šé»é¸æŸä¸€ç­†å¯ç·¨è¼¯ï¼›æœªé¸å–æ™‚æŒ‰ã€Œå„²å­˜ã€æœƒæ–°å¢ä¸€ç­†ï¼›æŒ‰ã€Œç›®å‰ã€å¯å¿«é€Ÿå¸¶å…¥ç•¶ä¸‹æ™‚é–“ã€‚</p>
            </section>

            <!-- æ»‘æ¡¿è¼¸å…¥å€ -->
            <section class="space-y-4 bg-white p-4 rounded-xl shadow-md border border-gray-100">

                <!-- æ”¶ç¸®å£“ -->
                <div class="space-y-1">
                    <div class="flex justify-between items-end">
                        <label class="text-lg font-bold text-rose-700 flex items-center gap-1">
                            æ”¶ç¸®å£“ <span class="text-[10px] font-normal text-gray-400">(mmHg)</span>
                        </label>
                        <span id="sysValue" class="text-4xl font-black text-rose-600">120</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="adjust('sys', -1)" class="btn-tap bg-rose-100 text-rose-700 rounded-xl text-2xl">ï¼</button>
                        <input type="range" id="sysRange" min="80" max="200" value="120" step="1" class="w-full" oninput="updateDisplay()" style="accent-color: var(--primary-red);">
                        <button onclick="adjust('sys', 1)" class="btn-tap bg-rose-100 text-rose-700 rounded-xl text-2xl">ï¼‹</button>
                    </div>
                </div>

                <!-- èˆ’å¼µå£“ -->
                <div class="space-y-1">
                    <div class="flex justify-between items-end">
                        <label class="text-lg font-bold text-teal-700 flex items-center gap-1">
                            èˆ’å¼µå£“ <span class="text-[10px] font-normal text-gray-400">(mmHg)</span>
                        </label>
                        <span id="diaValue" class="text-4xl font-black text-teal-600">70</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="adjust('dia', -1)" class="btn-tap bg-teal-100 text-teal-700 rounded-xl text-2xl">ï¼</button>
                        <input type="range" id="diaRange" min="40" max="120" value="70" step="1" class="w-full" oninput="updateDisplay()" style="accent-color: var(--primary-teal);">
                        <button onclick="adjust('dia', 1)" class="btn-tap bg-teal-100 text-teal-700 rounded-xl text-2xl">ï¼‹</button>
                    </div>
                </div>

                <!-- å¿ƒè·³ -->
                <div class="space-y-1">
                    <div class="flex justify-between items-end">
                        <label class="text-lg font-bold text-amber-700 flex items-center gap-1">
                            å¿ƒè·³ <span class="text-[10px] font-normal text-gray-400">(bpm)</span>
                        </label>
                        <span id="pulseValue" class="text-4xl font-black text-amber-600">70</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="adjust('pulse', -1)" class="btn-tap bg-amber-100 text-amber-700 rounded-xl text-2xl">ï¼</button>
                        <input type="range" id="pulseRange" min="40" max="140" value="70" step="1" class="w-full" oninput="updateDisplay()" style="accent-color: var(--primary-amber);">
                        <button onclick="adjust('pulse', 1)" class="btn-tap bg-amber-100 text-amber-700 rounded-xl text-2xl">ï¼‹</button>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="saveData()" id="saveBtn" class="col-span-2 py-3 bg-teal-600 text-white rounded-xl text-xl font-bold shadow-lg active:bg-teal-700 flex items-center justify-center gap-2">
                        <i data-lucide="save" size="22"></i> <span id="saveBtnText">å„²å­˜ï¼ˆæ–°å¢ï¼‰</span>
                    </button>
                    <button onclick="resetToDefault()" class="py-2 bg-gray-100 text-gray-600 rounded-xl font-bold border border-gray-200 flex items-center justify-center gap-1 text-sm">
                        <i data-lucide="rotate-ccw" size="14"></i> é‡è¨­å»ºè­°å€¼
                    </button>
                    <button onclick="deleteData()" id="deleteBtn" class="py-2 bg-white text-rose-600 rounded-xl font-bold border border-rose-200 flex items-center justify-center gap-1 text-sm">
                        <i data-lucide="trash-2" size="14"></i> <span id="deleteBtnText">åˆªé™¤æœ¬ç­†</span>
                    </button>
                </div>
            </section>
        </div>

        <!-- ================= é é¢ 2: è¶¨å‹¢åˆ†æ ================= -->
        <div id="page-trends" class="page-content hidden space-y-4">
            <section class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 space-y-3">
                <h3 class="text-lg font-bold flex items-center gap-2 text-gray-800">
                    <i data-lucide="line-chart" class="text-teal-500"></i> å¥åº·è¶¨å‹¢
                </h3>

                <div class="grid grid-cols-2 gap-2 bg-gray-50 p-2 rounded-lg border border-gray-100">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="startDate" class="border border-gray-200 rounded p-1 text-sm w-full" onchange="renderChart()">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">çµæŸæ—¥æœŸ</label>
                        <input type="date" id="endDate" class="border border-gray-200 rounded p-1 text-sm w-full" onchange="renderChart()">
                    </div>
                </div>

                <div class="bg-gray-50 p-2 rounded-lg border border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="text-[11px] text-gray-600 font-bold">é¡¯ç¤ºæ–¹å¼</div>
                        <div class="flex gap-2">
                            <label class="flex items-center gap-1 text-[11px] font-bold text-teal-700">
                                <input type="radio" name="trendMode" value="avg" checked onchange="renderChart()"> æ¯æ—¥å¹³å‡
                            </label>
                            <label class="flex items-center gap-1 text-[11px] font-bold text-gray-700">
                                <input type="radio" name="trendMode" value="each" onchange="renderChart()"> æ¯æ¬¡ç´€éŒ„
                            </label>
                        </div>
                    </div>
                    <div class="mt-1 text-[10px] text-gray-400">æ¯æ—¥å¹³å‡ï¼šçœ‹é•·æœŸè¶¨å‹¢æ›´æ¸…æ¥šï¼›æ¯æ¬¡ç´€éŒ„ï¼šçœ‹ç•¶å¤©æ³¢å‹•æ›´ç´°ã€‚</div>
                </div>

                <div class="relative w-full h-[300px]">
                    <canvas id="bpChart"></canvas>
                </div>
            </section>
        </div>

        <!-- ================= é é¢ 3: æ­·å²åˆ—è¡¨ ================= -->
        <div id="page-history" class="page-content hidden space-y-3">
            <section class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="bg-gray-50 p-3 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700 text-sm">æ­·å²ç´€éŒ„åˆ—è¡¨</h3>
                    <button onclick="exportToCSV()" class="px-3 py-1 bg-teal-600 text-white rounded-lg text-xs font-bold flex items-center gap-1 shadow">
                        <i data-lucide="download" size="12"></i> åŒ¯å‡º CSV
                    </button>
                </div>
                <div id="historyList" class="divide-y divide-gray-100 max-h-[70vh] overflow-y-auto"></div>
            </section>
        </div>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 h-20 flex justify-around items-center shadow-2xl z-40 max-w-md mx-auto">
        <button onclick="switchPage('page-record')" class="nav-btn active" id="nav-record">
            <i data-lucide="pencil-line" size="28"></i>
            <span class="font-medium">è¼¸å…¥æ•¸æ“š</span>
        </button>
        <button onclick="switchPage('page-trends')" class="nav-btn" id="nav-trends">
            <i data-lucide="trending-up" size="28"></i>
            <span class="font-medium">è¶¨å‹¢åˆ†æ</span>
        </button>
        <button onclick="switchPage('page-history')" class="nav-btn" id="nav-history">
            <i data-lucide="history" size="28"></i>
            <span class="font-medium">æ­·å²æ¸…å–®</span>
        </button>
    </nav>

    <div id="toast">æç¤ºè¨Šæ¯</div>

    <script>
        let bpChart = null;
        const DEFAULT_VALUES = { sys: 120, dia: 70, pulse: 70 };
        let currentPage = 'page-record';

        const STORAGE_KEY = 'senior_health_records';

        // WHO è¦ç¯„åƒè€ƒ (æ”¶ç¸®å£“ >= 140 æˆ– èˆ’å¼µå£“ >= 90)
        const THRESHOLD = { sys: 140, dia: 90 };

        // ç›®å‰æ˜¯å¦åœ¨ç·¨è¼¯æŸä¸€ç­†
        let currentEntryId = null;

        // ã€Œæ™‚é–“ã€æ˜¯å¦è¢«ä½¿ç”¨è€…æ‰‹å‹•èª¿æ•´éï¼ˆè£œç™»/æ‰‹å‹•æ”¹æ™‚é–“ï¼‰
        let timeTouched = false;

        window.onload = () => {
            lucide.createIcons();

            const today = getFormattedDate(new Date());
            document.getElementById('recordDate').value = today;
            document.getElementById('endDate').value = today;

            const lastTwoWeeks = new Date();
            lastTwoWeeks.setDate(lastTwoWeeks.getDate() - 14);
            document.getElementById('startDate').value = getFormattedDate(lastTwoWeeks);

            // é–‹å•Ÿ APP æ™‚ï¼šç›´æ¥æŠŠã€Œç•¶ä¸‹æ™‚é–“ã€å¸¶å…¥ç´€éŒ„æ™‚é–“ï¼ˆä¸æœƒè‡ªå‹•è·³å‹•ï¼‰
            setTimeNow(true);
            switchPage('page-record');
            loadDataByDate();
        };

        function switchPage(pageId) {
            currentPage = pageId;
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(pageId).classList.remove('hidden');
            const navId = 'nav-' + pageId.replace('page-', '');
            document.getElementById(navId).classList.add('active');

            if (pageId === 'page-trends') setTimeout(renderChart, 100);
            else if (pageId === 'page-history') renderHistoryList();

            lucide.createIcons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function getFormattedDate(date) { return date.toISOString().split('T')[0]; }

        function pad2(n) { return String(n).padStart(2, '0'); }

        function getNowTimeHHMM() {
            const d = new Date();
            return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
        }

        function setTimeNow(silent = true) {
            document.getElementById('recordTime').value = getNowTimeHHMM();
            if (!currentEntryId) updateActionButtons();
            // ä¸ä¸»å‹•è·³æç¤ºï¼Œé¿å…å¹²æ“¾
        }

        // ã€Œç›®å‰ã€ï¼šä¸€éµå¸¶å…¥ç•¶ä¸‹æ™‚é–“
        // éœ€æ±‚ï¼šä¸éœ€è¦å…ˆå„²å­˜ä¸€æ¬¡æ™‚é–“ï¼›æŒ‰ä¸‹å³å¯æŠŠæ™‚é–“è¨­ç‚ºç¾åœ¨ï¼Œä¸¦å›åˆ°ã€Œæ–°å¢æ¨¡å¼ã€
        function setNowTime() {
            currentEntryId = null;
            timeTouched = false;
            document.getElementById('editingBadge').classList.add('hidden');
            setTimeNow(true);
            updateActionButtons();
            renderDayEntries();
            showToast('â± å·²æ›´æ–°ç‚ºç›®å‰æ™‚é–“');
        }

        function onTimeChanged() {
            // ä½¿ç”¨è€…æ‰‹å‹•æ”¹å‹•æ™‚é–“ï¼šè¦–ç‚ºã€Œè£œç™»/èª¿æ•´ã€
            timeTouched = true;
            updateActionButtons();
        }

        function startNewEntry() {
            currentEntryId = null;
            timeTouched = false;
            document.getElementById('editingBadge').classList.add('hidden');
            setTimeNow(true);
            document.getElementById('sysRange').value = DEFAULT_VALUES.sys;
            document.getElementById('diaRange').value = DEFAULT_VALUES.dia;
            document.getElementById('pulseRange').value = DEFAULT_VALUES.pulse;
            updateDisplay();
            updateActionButtons();
            renderDayEntries();
            showToast('ğŸ“ å·²æº–å‚™æ–°å¢ä¸€ç­†');
        }

        function changeDate(days) {
            const el = document.getElementById('recordDate');
            const d = new Date(el.value);
            d.setDate(d.getDate() + days);
            el.value = getFormattedDate(d);
            loadDataByDate();
        }

        function adjust(type, amount) {
            const el = document.getElementById(type + 'Range');
            let val = parseInt(el.value) + amount;
            if (val >= el.min && val <= el.max) {
                el.value = val;
                updateDisplay();
            }
        }

        function updateDisplay() {
            const sys = document.getElementById('sysRange').value;
            const dia = document.getElementById('diaRange').value;
            const pulse = document.getElementById('pulseRange').value;
            document.getElementById('sysValue').innerText = sys;
            document.getElementById('diaValue').innerText = dia;
            document.getElementById('pulseValue').innerText = pulse;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = 'show';
            setTimeout(() => { t.className = ''; }, 3000);
        }

        function parseTimeToMinutes(t) {
            if (!t || typeof t !== 'string' || !t.includes(':')) return 0;
            const [hh, mm] = t.split(':').map(x => parseInt(x, 10));
            return (hh * 60) + (mm || 0);
        }

        function makeId() {
            return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
        }

        function normalizeRecords(raw) {
            const out = {};
            let changed = false;

            if (!raw || typeof raw !== 'object') return { records: {}, changed: true };

            for (const date of Object.keys(raw)) {
                const v = raw[date];

                // èˆŠç‰ˆï¼š{sys,dia,pulse}
                if (v && typeof v === 'object' && !Array.isArray(v) && ('sys' in v) && ('dia' in v) && ('pulse' in v)) {
                    out[date] = [{
                        id: makeId(),
                        time: '08:00',
                        sys: parseInt(v.sys, 10),
                        dia: parseInt(v.dia, 10),
                        pulse: parseInt(v.pulse, 10)
                    }];
                    changed = true;
                    continue;
                }

                // æ–°ç‰ˆï¼š[{id,time,sys,dia,pulse}, ...]
                if (Array.isArray(v)) {
                    const arr = v
                        .filter(x => x && typeof x === 'object')
                        .map(x => ({
                            id: x.id || makeId(),
                            time: x.time || '08:00',
                            sys: parseInt(x.sys, 10),
                            dia: parseInt(x.dia, 10),
                            pulse: parseInt(x.pulse, 10)
                        }))
                        .filter(x => Number.isFinite(x.sys) && Number.isFinite(x.dia) && Number.isFinite(x.pulse));

                    out[date] = arr;
                    if (arr.length !== v.length) changed = true;
                    if (v.some(x => !x.id || !x.time)) changed = true;
                    continue;
                }

                // å…¶ä»–ç•°å¸¸è³‡æ–™ï¼šç•¥é
                changed = true;
            }

            return { records: out, changed };
        }

        function readRecords() {
            const raw = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const { records, changed } = normalizeRecords(raw);
            if (changed) localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            return records;
        }

        function writeRecords(records) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        }

        function getEntriesOfDate(records, dateStr) {
            const entries = (records[dateStr] || []).slice();
            entries.sort((a, b) => parseTimeToMinutes(a.time) - parseTimeToMinutes(b.time));
            return entries;
        }

        function computeAverages(entries) {
            if (!entries || entries.length === 0) return null;
            const sum = entries.reduce((acc, e) => {
                acc.sys += e.sys; acc.dia += e.dia; acc.pulse += e.pulse;
                return acc;
            }, { sys: 0, dia: 0, pulse: 0 });

            return {
                sys: Math.round(sum.sys / entries.length),
                dia: Math.round(sum.dia / entries.length),
                pulse: Math.round(sum.pulse / entries.length),
                count: entries.length
            };
        }

        function getSelectedTrendMode() {
            const el = document.querySelector('input[name="trendMode"]:checked');
            return el ? el.value : 'avg';
        }

        function updateActionButtons() {
            const saveText = document.getElementById('saveBtnText');
            const delText = document.getElementById('deleteBtnText');

            if (currentEntryId) {
                saveText.innerText = 'å„²å­˜ï¼ˆæ›´æ–°ï¼‰';
                delText.innerText = 'åˆªé™¤æœ¬ç­†';
                document.getElementById('editingBadge').classList.remove('hidden');
            } else {
                saveText.innerText = 'å„²å­˜ï¼ˆæ–°å¢ï¼‰';
                delText.innerText = 'åˆªé™¤æœ¬æ—¥';
                document.getElementById('editingBadge').classList.add('hidden');
            }
        }

        function loadEntryToUI(entry) {
            if (!entry) return;
            // é€²å…¥ã€Œç·¨è¼¯ã€ç‹€æ…‹ï¼šæ™‚é–“ä»¥è³‡æ–™ç‚ºæº–ï¼Œä¸å†è‡ªå‹•è¦†è“‹
            timeTouched = true;
            document.getElementById('recordTime').value = entry.time || '08:00';
            document.getElementById('sysRange').value = entry.sys;
            document.getElementById('diaRange').value = entry.dia;
            document.getElementById('pulseRange').value = entry.pulse;
            updateDisplay();
        }

        function findEntry(entries, entryId) {
            return entries.find(e => e.id === entryId);
        }

        function selectEntry(entryId) {
            const dateStr = document.getElementById('recordDate').value;
            const records = readRecords();
            const entries = getEntriesOfDate(records, dateStr);
            const entry = findEntry(entries, entryId);
            if (!entry) return;

            currentEntryId = entryId;
            loadEntryToUI(entry);
            updateActionButtons();
            renderDayEntries(entries);
            showToast(`âœï¸ ç·¨è¼¯ï¼š${entry.time}`);
        }

        function loadDataByDate() {
            const dateStr = document.getElementById('recordDate').value;
            const records = readRecords();
            const entries = getEntriesOfDate(records, dateStr);

            const today = getFormattedDate(new Date());
            const statusEl = document.getElementById('dateStatus');

            if (dateStr === today) {
                statusEl.innerText = 'ğŸ“… ä»Šå¤©';
                statusEl.className = 'text-center text-xs text-teal-600 mt-1 font-bold';
            } else {
                statusEl.innerText = entries.length ? `âœ… å·²ç´€éŒ„ ${entries.length} ç­†` : 'ğŸ“ å°šæœªè¼¸å…¥';
                statusEl.className = entries.length ? 'text-center text-xs text-green-600 mt-1 font-medium' : 'text-center text-xs text-gray-400 mt-1 font-medium';
            }

            // é€²åˆ°æŸå¤©æ™‚ï¼š
            // - è‹¥é‚„æœ‰é¸å– id ä¸”å­˜åœ¨ -> ç•™åœ¨é‚£ç­†
            // - å¦å‰‡é¸æœ€å¾Œä¸€ç­†ï¼ˆæ™‚é–“æœ€æ™šï¼‰
            if (entries.length === 0) {
                currentEntryId = null;
                timeTouched = false;
                setTimeNow(true);
                document.getElementById('sysRange').value = DEFAULT_VALUES.sys;
                document.getElementById('diaRange').value = DEFAULT_VALUES.dia;
                document.getElementById('pulseRange').value = DEFAULT_VALUES.pulse;
                updateDisplay();
            } else {
                let entry = null;
                if (currentEntryId) {
                    entry = findEntry(entries, currentEntryId);
                }
                if (!entry) {
                    entry = entries[entries.length - 1];
                    currentEntryId = entry.id;
                }
                loadEntryToUI(entry);
            }

            updateActionButtons();
            renderDayEntries(entries);
        }

        function renderDayEntries(overrideEntries = null) {
            const dateStr = document.getElementById('recordDate').value;
            const listEl = document.getElementById('dayEntries');

            const records = readRecords();
            const entries = overrideEntries || getEntriesOfDate(records, dateStr);

            const avg = computeAverages(entries);
            const summaryEl = document.getElementById('daySummary');
            summaryEl.innerText = avg ? `${avg.count} ç­†ï½œå¹³å‡ ${avg.sys}/${avg.dia}ï½œå¿ƒè·³ ${avg.pulse}` : '0 ç­†';

            if (!entries.length) {
                listEl.innerHTML = `<div class="p-4 text-center text-gray-400 text-sm">ä»Šå¤©é‚„æ²’æœ‰ç´€éŒ„</div>`;
                return;
            }

            listEl.innerHTML = entries.map(e => {
                const isHigh = e.sys >= THRESHOLD.sys || e.dia >= THRESHOLD.dia;
                const warningIcon = isHigh ? '<i data-lucide="alert-triangle" class="text-rose-600" size="14"></i>' : '<i data-lucide="check-circle-2" class="text-green-600" size="14"></i>';
                const selectedClass = (currentEntryId === e.id) ? 'entry-selected' : '';

                return `
                    <button onclick="selectEntry('${e.id}')" class="w-full text-left p-3 rounded-xl border border-gray-100 shadow-sm bg-white active:bg-gray-50 transition ${selectedClass}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                ${warningIcon}
                                <div class="text-lg font-black text-gray-800">${e.time}</div>
                                ${isHigh ? '<span class="pill bg-rose-50 text-rose-700 border border-rose-100">åé«˜</span>' : '<span class="pill bg-green-50 text-green-700 border border-green-100">OK</span>'}
                            </div>
                            <div class="text-[10px] text-teal-600 font-bold">é»é¸ç·¨è¼¯ ></div>
                        </div>
                        <div class="mt-2 flex gap-2 items-center">
                            <span class="px-2 py-0.5 bg-rose-50 text-rose-700 rounded text-xs font-bold border border-rose-100">æ”¶ç¸® ${e.sys}</span>
                            <span class="px-2 py-0.5 bg-teal-50 text-teal-700 rounded text-xs font-bold border border-teal-100">èˆ’å¼µ ${e.dia}</span>
                            <span class="px-2 py-0.5 bg-amber-50 text-amber-700 rounded text-xs font-bold border border-amber-100">å¿ƒè·³ ${e.pulse}</span>
                        </div>
                    </button>
                `;
            }).join('');

            lucide.createIcons();
        }

        function saveData() {
            const dateStr = document.getElementById('recordDate').value;
            const timeStr = (document.getElementById('recordTime').value || '').trim() || getNowTimeHHMM();

            const data = {
                sys: parseInt(document.getElementById('sysRange').value, 10),
                dia: parseInt(document.getElementById('diaRange').value, 10),
                pulse: parseInt(document.getElementById('pulseRange').value, 10)
            };

            const records = readRecords();
            const entries = getEntriesOfDate(records, dateStr);

            // è‹¥æœªåœ¨ç·¨è¼¯ï¼Œä¸”åŒä¸€æ™‚é–“å·²æœ‰è³‡æ–™ï¼šè©¢å•æ˜¯å¦è¦†è“‹
            if (!currentEntryId) {
                const sameTime = entries.find(e => e.time === timeStr);
                if (sameTime) {
                    if (confirm(`æ™‚é–“ ${timeStr} å·²æœ‰ä¸€ç­†ç´€éŒ„ï¼Œè¦è¦†è“‹å®ƒå—ï¼Ÿ`)) {
                        currentEntryId = sameTime.id;
                    } else {
                        return;
                    }
                }
            }

            // é™åˆ¶å»ºè­°ï¼šä¸€å¤©å¸¸è¦‹ 3 æ¬¡ï¼ˆä½†å…è¨±æ›´å¤šï¼‰
            if (!currentEntryId && entries.length >= 3) {
                const ok = confirm(`ä»Šå¤©å·²ç¶“æœ‰ ${entries.length} ç­†äº†ï¼Œä»è¦å†æ–°å¢ä¸€ç­†å—ï¼Ÿ`);
                if (!ok) return;
            }

            if (currentEntryId) {
                const idx = entries.findIndex(e => e.id === currentEntryId);
                if (idx >= 0) {
                    entries[idx] = { ...entries[idx], time: timeStr, ...data };
                    showToast('âœ… å·²æ›´æ–°');
                } else {
                    // è¬ä¸€æ‰¾ä¸åˆ°ï¼Œå°±ç•¶ä½œæ–°å¢
                    entries.push({ id: makeId(), time: timeStr, ...data });
                    currentEntryId = entries[entries.length - 1].id;
                    showToast('âœ… å·²æ–°å¢');
                }
            } else {
                const newEntry = { id: makeId(), time: timeStr, ...data };
                entries.push(newEntry);
                currentEntryId = newEntry.id;
                showToast('âœ… å·²æ–°å¢');
            }

            // å¯«å›
            records[dateStr] = entries;
            writeRecords(records);

            updateActionButtons();
            renderDayEntries(entries);
            loadDataByDate();
        }

        function deleteData() {
            const dateStr = document.getElementById('recordDate').value;
            const records = readRecords();
            const entries = getEntriesOfDate(records, dateStr);

            if (!entries.length) {
                showToast('æ²’æœ‰å¯åˆªé™¤çš„è³‡æ–™');
                return;
            }

            if (currentEntryId) {
                const entry = entries.find(e => e.id === currentEntryId);
                if (!entry) {
                    currentEntryId = null;
                    updateActionButtons();
                    return;
                }

                if (!confirm(`ç¢ºå®šåˆªé™¤ ${entry.time} é€™ç­†ç´€éŒ„å—ï¼Ÿ`)) return;
                const next = entries.filter(e => e.id !== currentEntryId);
                records[dateStr] = next;
                if (next.length === 0) delete records[dateStr];
                writeRecords(records);

                currentEntryId = null;
                showToast('ğŸ—‘ï¸ å·²åˆªé™¤æœ¬ç­†');
                loadDataByDate();
                return;
            }

            // æœªé¸å–ï¼šåˆªé™¤æœ¬æ—¥
            if (!confirm(`ç¢ºå®šåˆªé™¤ ${dateStr} çš„å…¨éƒ¨ ${entries.length} ç­†ç´€éŒ„å—ï¼Ÿ`)) return;
            delete records[dateStr];
            writeRecords(records);
            showToast('ğŸ—‘ï¸ å·²åˆªé™¤æœ¬æ—¥');
            loadDataByDate();
        }

        function resetToDefault() {
            document.getElementById('sysRange').value = DEFAULT_VALUES.sys;
            document.getElementById('diaRange').value = DEFAULT_VALUES.dia;
            document.getElementById('pulseRange').value = DEFAULT_VALUES.pulse;
            updateDisplay();
            showToast('å·²é‡è¨­ç‚ºå»ºè­°å€¼');
        }

        function renderChart() {
            if (currentPage !== 'page-trends') return;

            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const mode = getSelectedTrendMode();

            const records = readRecords();
            const dates = Object.keys(records).filter(d => d >= start && d <= end).sort();

            let labels = [];
            let sysData = [];
            let diaData = [];
            let pulseData = [];

            if (mode === 'avg') {
                labels = dates.map(d => d.substring(5));
                dates.forEach(d => {
                    const entries = getEntriesOfDate(records, d);
                    const avg = computeAverages(entries);
                    if (!avg) return;
                    sysData.push(avg.sys);
                    diaData.push(avg.dia);
                    pulseData.push(avg.pulse);
                });
            } else {
                // æ¯æ¬¡ç´€éŒ„
                const points = [];
                dates.forEach(d => {
                    const entries = getEntriesOfDate(records, d);
                    entries.forEach(e => {
                        points.push({
                            label: `${d.substring(5)} ${e.time}`,
                            sys: e.sys,
                            dia: e.dia,
                            pulse: e.pulse,
                            t: (d + 'T' + (e.time || '00:00'))
                        });
                    });
                });

                points.sort((a, b) => (a.t < b.t ? -1 : a.t > b.t ? 1 : 0));
                labels = points.map(p => p.label);
                sysData = points.map(p => p.sys);
                diaData = points.map(p => p.dia);
                pulseData = points.map(p => p.pulse);
            }

            const ctx = document.getElementById('bpChart').getContext('2d');
            if (bpChart) bpChart.destroy();

            bpChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'æ”¶ç¸®å£“', data: sysData, borderColor: '#e11d48', backgroundColor: '#e11d48', tension: 0.3, pointRadius: mode === 'each' ? 3 : 4 },
                        { label: 'èˆ’å¼µå£“', data: diaData, borderColor: '#0d9488', backgroundColor: '#0d9488', tension: 0.3, pointRadius: mode === 'each' ? 3 : 4 },
                        { label: 'å¿ƒè·³', data: pulseData, borderColor: '#d97706', backgroundColor: '#d97706', tension: 0.3, pointRadius: mode === 'each' ? 3 : 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 12 }, usePointStyle: true } }
                    },
                    scales: {
                        x: { ticks: { maxRotation: 0, autoSkip: true } }
                    }
                }
            });
        }

        function renderHistoryList() {
            const listEl = document.getElementById('historyList');
            const records = readRecords();
            const sortedDates = Object.keys(records).sort().reverse();

            if (sortedDates.length === 0) {
                listEl.innerHTML = `<div class="p-10 text-center text-gray-400">å°šç„¡æ­·å²æ•¸æ“š</div>`;
                return;
            }

            listEl.innerHTML = sortedDates.map(date => {
                const entries = getEntriesOfDate(records, date);
                const avg = computeAverages(entries);

                const anyHigh = entries.some(e => e.sys >= THRESHOLD.sys || e.dia >= THRESHOLD.dia);
                const bgColor = anyHigh ? 'background-color: var(--warning-bg);' : 'background-color: white;';
                const warningIcon = anyHigh ? '<i data-lucide="alert-triangle" class="text-rose-600 mr-1" size="14"></i>' : '';

                const last = entries.length ? entries[entries.length - 1] : null;
                const sub = avg ? `å¹³å‡ ${avg.sys}/${avg.dia}ï½œå¿ƒè·³ ${avg.pulse}` : '';
                const lastTxt = last ? `æœ€æ–° ${last.time}` : '';

                return `
                    <div class="p-4 flex justify-between items-center active:bg-gray-50 border-b border-gray-100 transition-colors" style="${bgColor}" onclick="jumpToDate('${date}')">
                        <div class="space-y-1">
                            <div class="text-lg font-bold text-gray-800 flex items-center">${warningIcon} ${date}</div>
                            <div class="text-[11px] text-gray-600 font-bold">${entries.length} ç­†ï½œ${sub}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-teal-700 font-black text-sm">${lastTxt}</div>
                            <div class="text-[10px] text-teal-600 font-bold">é»æ“ŠæŸ¥çœ‹ ></div>
                        </div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        function jumpToDate(date) {
            document.getElementById('recordDate').value = date;
            switchPage('page-record');
            // æ›æ—¥å¾Œå…ˆæ¸…ç©ºé¸å–ï¼Œè®“å®ƒè‡ªå‹•é¸æœ€æ–°ä¸€ç­†
            currentEntryId = null;
            loadDataByDate();
            showToast('å·²è¼‰å…¥ ' + date);
        }

        function exportToCSV() {
            const records = readRecords();
            const sortedDates = Object.keys(records).sort();
            if (sortedDates.length === 0) {
                showToast('ç„¡è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            let csvContent = 'æ—¥æœŸ,æ™‚é–“,æ”¶ç¸®å£“,èˆ’å¼µå£“,å¿ƒè·³\n';

            sortedDates.forEach(date => {
                const entries = getEntriesOfDate(records, date);
                entries.forEach(e => {
                    csvContent += `${date},${e.time},${e.sys},${e.dia},${e.pulse}\n`;
                });
            });

            const BOM = "\uFEFF";
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `è¡€å£“ç´€éŒ„å°å¹«æ‰‹åŒ¯å‡º_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
            showToast('âœ… CSV åŒ¯å‡ºæˆåŠŸ');
        }

    </script>

    <!-- Service Worker è¨»å†Šï¼ˆPWA é›¢ç·šå¿«å–ï¼‰ -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .catch(err => console.warn('Service Worker è¨»å†Šå¤±æ•—ï¼š', err));
            });
        }
    </script>

</body>
</html>
